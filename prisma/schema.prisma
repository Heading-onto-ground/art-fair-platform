generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  artist
  gallery
}

model User {
  id           String          @id @default(cuid())
  email        String          @unique
  role         Role
  passwordHash String
  createdAt    DateTime        @default(now())
  artistProfile ArtistProfile?
  galleryProfile GalleryProfile?
}

model ArtistProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  artistId     String   @unique
  name         String
  startedYear  Int
  genre        String
  instagram    String?
  country      String?
  city         String?
  website      String?
  bio          String?
  portfolioUrl String?
  profileImage String?  // Base64 data URI or URL
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model GalleryProfile {
  id           String   @id @default(cuid())
  userId       String   @unique
  user         User     @relation(fields: [userId], references: [id])
  galleryId    String   @unique
  name         String
  address      String
  foundedYear  Int
  instagram    String?
  country      String?
  city         String?
  website      String?
  bio          String?
  profileImage String?  // Base64 data URI or URL
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model ChatRoom {
  id          String    @id @default(cuid())
  artistId    String
  galleryId   String
  openCallId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  messages    Message[]

  @@unique([artistId, galleryId, openCallId])
}

model Message {
  id         String   @id @default(cuid())
  roomId     String
  room       ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  senderId   String
  senderRole Role
  text       String
  createdAt  DateTime @default(now())

  @@index([roomId])
}

// ========== 오픈콜 시스템 ==========

model OpenCall {
  id                 String   @id @default(cuid())
  galleryId          String
  gallery            String
  city               String
  country            String
  theme              String
  exhibitionDate     String?
  deadline           String
  posterImage        String?  // Base64 data URI for poster/banner
  isExternal         Boolean  @default(false)
  externalEmail      String?
  externalUrl        String?
  galleryWebsite     String?
  galleryDescription String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([country])
  @@index([galleryId])
  @@index([isExternal])
}

// ========== 지원 시스템 ==========

enum ApplicationStatus {
  submitted
  reviewing
  accepted
  rejected
}

enum AppShippingStatus {
  pending
  shipped
  received
  inspected
  exhibited
}

model Application {
  id              String            @id @default(cuid())
  openCallId      String
  artistId        String
  galleryId       String
  artistName      String            @default("")
  artistEmail     String            @default("")
  artistCountry   String            @default("")
  artistCity      String            @default("")
  artistPortfolioUrl String?
  message         String?
  portfolioUrl    String?
  status          ApplicationStatus @default(submitted)
  shippingStatus  AppShippingStatus @default(pending)
  shippingNote    String?
  shippingCarrier String?
  trackingNumber  String?
  trackingUrl     String?
  isExternal      Boolean           @default(false)
  outreachSent    Boolean           @default(false)
  outreachSentAt  DateTime?
  outreachNote    String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  shipment        Shipment?

  @@unique([openCallId, artistId])
  @@index([artistId])
  @@index([galleryId])
  @@index([isExternal])
}

// ========== 커뮤니티 시스템 ==========

model CommunityPost {
  id          String             @id @default(cuid())
  authorId    String
  authorName  String
  authorRole  String             // "artist" | "gallery"
  category    String             @default("general")
  title       String
  content     String
  imageUrl    String?
  pinned      Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  comments    CommunityComment[]
  likes       CommunityLike[]

  @@index([category])
  @@index([authorId])
}

model CommunityComment {
  id          String        @id @default(cuid())
  postId      String
  post        CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId    String
  authorName  String
  authorRole  String
  content     String
  createdAt   DateTime      @default(now())

  @@index([postId])
}

model CommunityLike {
  id        String        @id @default(cuid())
  postId    String
  post      CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime      @default(now())

  @@unique([postId, userId])
  @@index([postId])
}

// ========== 알림 시스템 ==========

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "new_application", "application_accepted", etc.
  title     String
  message   String
  link      String?
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([userId, read])
}

// ========== 아웃리치 시스템 ==========

model OutreachRecord {
  id          String   @id @default(cuid())
  toEmail     String
  galleryName String
  country     String
  language    String   @default("en")
  status      String   @default("sent") // "sent", "opened", "clicked", "signed_up", "failed"
  sentAt      DateTime @default(now())
  openedAt    DateTime?
  clickedAt   DateTime?
  signedUpAt  DateTime?

  @@index([status])
}

// ========== 물류 시스템 ==========

enum ShipmentStatus {
  pending
  scheduled
  pickup_requested
  picked_up
  in_transit
  customs
  out_for_delivery
  delivered
  returned
}

enum ShipmentType {
  local
  international
}

model Shipment {
  id              String          @id @default(cuid())
  applicationId   String          @unique
  application     Application     @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  type            ShipmentType    @default(local)
  carrier         String
  carrierName     String
  status          ShipmentStatus  @default(pending)
  trackingNumber  String?
  trackingUrl     String?
  pickupDate      DateTime?
  pickupTime      String?
  pickupAddress   String
  pickupContact   String
  pickupNote      String?
  deliveryAddress String
  deliveryContact String
  artworkTitle    String?
  artworkSize     String?
  artworkWeight   String?
  packageCount    Int             @default(1)
  insured         Boolean         @default(false)
  insuranceValue  Float?
  estimatedCost   Float?
  actualCost      Float?
  currency        String          @default("KRW")
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  pickedUpAt      DateTime?
  deliveredAt     DateTime?
  events          ShipmentEvent[]

  @@index([status])
}

model ShipmentEvent {
  id          String         @id @default(cuid())
  shipmentId  String
  shipment    Shipment       @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
  status      ShipmentStatus
  location    String?
  description String
  createdAt   DateTime       @default(now())

  @@index([shipmentId])
}

model PasswordResetOtp {
  id                   String   @id @default(cuid())
  email                String
  role                 Role
  otpHash              String
  otpExpiresAt         DateTime
  attempts             Int      @default(0)
  resetSessionId       String?  @unique
  resetSessionExpiresAt DateTime?

  @@unique([email, role])
  @@index([email])
  @@index([resetSessionId])
}

// ========== 관리자 설정 ==========

model AdminSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}
